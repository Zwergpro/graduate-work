{% extends 'base.html' %}

{% block head %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.2.1/dist/chart.min.js" integrity="sha256-uVEHWRIr846/vAdLJeybWxjPNStREzOlqLMXjW/Saeo=" crossorigin="anonymous"></script>
{% endblock %}

{% block train_nav_el %}active{% endblock %}

{% block content %}
    <br><br>
    {% if active_train %}
        <table>
            <tr>
                <th>Name</th>
                <th>Start</th>
                <th>End</th>
                <th>Status</th>
                <th>Delete</th>
            </tr>
            <tr>
                <td><span  title="{{ active_train.path }}">{{ active_train.name }}</span></td>
                <td>{{ active_train.dt_start }}</td>
                <td>{{ active_train.dt_end }}</td>
                <td>
                    {% if active_train.status == active_train.status.end %}
                        <span class="badge bg-success">{{ active_train.status.name }}</span>
                    {% elif active_train.status == active_train.status.fail %}
                        <span class="badge bg-danger">{{ active_train.status.name }}</span>
                    {% elif active_train.status == active_train.status.train %}
                        <span class="badge bg-primary">{{ active_train.status.name }}</span>
                    {% else %}
                        <span class="badge bg-info text-dark">{{ active_train.status.name }}</span>
                    {% endif %}
                </td>
                <td>
                    <form action="{{ url_for('train.delete') }}" method="post">
                        <input type="hidden" name="train_id" value="{{ active_train.id }}">
                        <button type="submit" class="btn btn-danger">Delete</button>
                    </form>
                </td>
            </tr>
        </table>
        <br>
        <div style="text-align: center">
            {% if active_train.status == active_train.status.train %}
                <h3>Обучение...</h3>
                <canvas id="speedChart" width="200" height="100"></canvas>
            {% elif active_train.status in (active_train.status.loading,  active_train.status.prepare) %}
                <h3>Подготовка данных...</h3>
                <div class="d-flex justify-content-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            {% endif %}
        </div>
    {% else %}
        <form action="{{ url_for('train.start_train') }}" method="post">
            <select class="form-select" aria-label="Default select example" name="dataset">
                {% for dataset in datasets %}
                    <option value="{{ dataset.id }}">{{ dataset.name }}</option>
                {% endfor %}
            </select>
            <br>
            <button type="submit" class="btn btn-primary">Тренировать</button>
        </form>
    {% endif %}

    <br><br>

    <h2>Архив</h2>
    <table>
        <tr>
            <th>Name</th>
            <th>Start</th>
            <th>End</th>
            <th>Status</th>
            <th>Delete</th>
        </tr>
        {% for train_model in train_models %}
            <tr>
                <td><span  title="{{ train_model.path }}">{{ train_model.name }}</span></td>
                <td>{{ train_model.dt_start }}</td>
                <td>{{ train_model.dt_end }}</td>
                <td>
                    {% if train_model.status == train_model.status.end %}
                        <span class="badge bg-success">{{ train_model.status.name }}</span>
                    {% elif train_model.status == train_model.status.fail %}
                        <span class="badge bg-danger">{{ train_model.status.name }}</span>
                    {% elif train_model.status == train_model.status.train %}
                        <span class="badge bg-primary">{{ train_model.status.name }}</span>
                    {% else %}
                        <span class="badge bg-info text-dark">{{ train_model.status.name }}</span>
                    {% endif %}
                </td>
                <td>
                    <form action="{{ url_for('train.delete') }}" method="post">
                        <input type="hidden" name="train_id" value="{{ train_model.id }}">
                        <button type="submit" class="btn btn-danger">Delete</button>
                    </form>
                </td>
            </tr>
        {% endfor %}
    </table>
    <br><br>
{% endblock %}

<script>
{% block scripts %}
    function getChart() {
        let speedData = {
            labels: [],
            datasets: [
                {
                    label: "Test",
                    data: [],
                    lineTension: 0,
                    borderWidth: 2,
                    radius: 0,
                    fill: true,
                    borderColor: 'red'
                },
                {
                    label: "Train",
                    data: [],
                    lineTension: 0,
                    borderWidth: 2,
                    radius: 0,
                    fill: true,
                    borderColor: 'blue'
                }
            ]
        };

        let chartOptions = {
            legend: {
                display: true,
                position: 'top',
                labels: {
                    boxWidth: 80,
                    fontColor: 'black'
                }
            },
        };

        return new Chart(document.getElementById("speedChart"), {
            type: 'line',
            data: speedData,
            options: chartOptions
        });
    }

    async function getNextSlice(index) {
        try {
            let response = await fetch(`{{ url_for('train.chart') }}?index=${index}&train_id={{ active_train.id }}`);
            return await response.json();
        } catch (err) {
            return [];
        }
    }

    function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    document.addEventListener("DOMContentLoaded", async function () {
        if (document.getElementById("speedChart") === null) return;

        let data;
        let index = 0;
        let chart = getChart();
        let tries = 0;

        while (true) {
            data = await getNextSlice(index);
            if (data.length === 0) {
                tries++;
                if (tries > 4) return;
                await sleep(3000);
                continue
            }
            tries = 0;

            data.forEach((element) => {
                chart.data.labels.push(element.iteration);
                chart.data.datasets[0].data.push(element.learn[0]);
                chart.data.datasets[1].data.push(element.test[0]);
                index++;
            })
            chart.update();
            await sleep(2000);
        }

    });
{% endblock %}
</script>
